<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PortWatch – Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* Minimal fallback styles so dynamically injected KILL button looks like a button
       even if Tailwind CDN hasn't generated the utility classes yet. */
    #killInModal {
      display: inline-block;
      padding: 0.5rem 0.75rem; /* px-3 py-2 */
      background: #991b1b;    /* red-800 */
      color: #fff;
      border-radius: 0.375rem; /* rounded */
      border: 1px solid #7f1d1d; /* ring-red-900 */
      text-decoration: none;
      cursor: pointer;
    }
    #killInModal:hover { background: #b91c1c; } /* red-700 */
    /* Same style for related action buttons */
    #killTreeInModal, #bootoutInModal {
      display: inline-block;
      padding: 0.5rem 0.75rem;
      background: #334155; /* slate-700 for alt */
      color: #e2e8f0;
      border-radius: 0.375rem;
      border: 1px solid #1f2937;
      cursor: pointer;
    }
    #killTreeInModal:hover, #bootoutInModal:hover { background: #475569; }
  </style>
  <link rel="icon" href="data:," />
  <meta name="color-scheme" content="dark light">
</head>
<body class="bg-slate-950 text-slate-100">
  <main class="max-w-7xl mx-auto px-4 py-6">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-semibold">PortWatch <span class="text-slate-400 text-base">Conexiones activas</span></h1>
      <div class="flex items-center gap-2 flex-wrap">
        <input id="q" type="text" placeholder="Filtrar: proc, user, ip, puerto…" class="px-3 py-2 bg-slate-900/60 ring-1 ring-slate-800 rounded-md w-72" />
        <label class="inline-flex items-center gap-2 text-sm text-slate-300">
          <input id="auto" type="checkbox" class="accent-emerald-500" checked /> Auto
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-300">
          <input id="groupBy" type="checkbox" class="accent-emerald-500" /> Agrupar por servicio
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-300" title="Vista resumida para no técnicos">
          <input id="easyMode" type="checkbox" class="accent-emerald-500" /> Modo simple
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-300">
          <input id="hideApple" type="checkbox" class="accent-emerald-500" /> Ocultar Apple
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-300">
          <input id="onlyNonApple" type="checkbox" class="accent-emerald-500" /> Solo no Apple
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-300">
          <input id="onlyEstablished" type="checkbox" class="accent-emerald-500" /> Solo ESTABLISHED
        </label>
        <button id="refresh" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-md">Actualizar</button>
        <button id="paranoidBtn" class="px-3 py-2 bg-red-800 hover:bg-red-700 rounded-md ring-1 ring-red-900" title="Muestra controles para detener/terminar procesos sospechosos">Modo paranoico: OFF</button>
        <select id="paranoidActionSel" class="hidden px-2 py-2 bg-red-900/40 ring-1 ring-red-800 rounded-md text-sm">
          <option value="kill">Auto: Kill</option>
          <option value="stop">Auto: Stop</option>
        </select>
        <button id="btnOptions" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-md">Opciones ▾</button>
        <div id="menu" class="hidden absolute right-0 top-12 z-40 w-[320px] bg-slate-900 ring-1 ring-slate-800 rounded-lg p-3 shadow-lg">
          <div class="text-slate-300 text-sm mb-2">Preferencias</div>
          <div class="grid grid-cols-1 gap-2">
            <label class="inline-flex items-center gap-2 text-sm text-slate-200" title="Actualiza automáticamente cada 2 segundos">
              <input id="auto" type="checkbox" class="accent-emerald-500" checked /> Auto
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-200">
              <input id="groupBy" type="checkbox" class="accent-emerald-500" /> Agrupar por servicio
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-200" title="Vista resumida para no técnicos">
              <input id="easyMode" type="checkbox" class="accent-emerald-500" /> Modo simple
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-200">
              <input id="hideApple" type="checkbox" class="accent-emerald-500" /> Ocultar Apple
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-200">
              <input id="onlyNonApple" type="checkbox" class="accent-emerald-500" /> Solo no Apple
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-200">
              <input id="onlyEstablished" type="checkbox" class="accent-emerald-500" /> Solo ESTABLISHED
            </label>
          </div>
        </div>
      </div>
    </header>
    <p id="meta" class="text-slate-400 text-sm mt-2">Cargando…</p>
    <div id="hackAlert" class="hidden mt-3 p-3 rounded-lg bg-red-900 text-red-200 ring-1 ring-red-800 flex items-center justify-between gap-3">
      <div class="text-lg font-semibold">¡HACKEADO!</div>
      <button id="hackResolve" class="px-2 py-1 text-xs bg-slate-900/40 hover:bg-slate-900/60 text-slate-200 rounded ring-1 ring-red-800">Resolver</button>
    </div>

    <section class="mt-4 overflow-x-auto">
      <table class="w-full text-sm" id="table">
        <thead id="thead" class="text-slate-300"></thead>
        <tbody id="rows" class="align-top"></tbody>
      </table>
    </section>
    <section id="simple" class="hidden mt-4">
      <div id="summary" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
      <div class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Conexiones a revisar</h3>
          <button id="toggleArchived" class="px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded">Mostrar archivados</button>
        </div>
        <div id="topList" class="space-y-2"></div>
        <div id="archList" class="hidden space-y-2 mt-3"></div>
      </div>
      <div class="mt-6">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold">Conexiones normales</h3>
          <button id="toggleNormals" class="px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded">Mostrar</button>
        </div>
        <div id="normList" class="hidden space-y-2 mt-2"></div>
      </div>
      <div class="mt-6">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold">Histórico (hoy)</h3>
          <button id="clearHistory" class="px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded">Borrar</button>
        </div>
        <div id="histList" class="text-sm text-slate-300 mt-2"></div>
      </div>
    </section>
    <!-- Modal -->
    <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative bg-slate-900 ring-1 ring-slate-800 rounded-lg max-w-3xl w-[90%] max-h-[80vh] overflow-auto p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 id="modalTitle" class="text-lg font-semibold">Detalles</h2>
          <button id="modalClose" class="px-2 py-1 text-sm bg-slate-800 hover:bg-slate-700 rounded">Cerrar</button>
        </div>
        <div id="modalBody" class="text-sm"></div>
      </div>
    </div>
  </main>

  <script>
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  const rowsEl = $('#rows');
  const meta = $('#meta');
  const q = $('#q');
  let timer = null;
  let last = [];

  const thead = $('#thead');
  const menu = $('#menu');
  const btnOptions = $('#btnOptions');
  // Config persistente en localStorage
  function getCfg(){
    try { return JSON.parse(localStorage.getItem('pwCfg') || '{}'); }
    catch(_){ return {}; }
  }
  function setCfg(part){
    const cur = getCfg();
    const next = Object.assign({}, cur, part || {});
    localStorage.setItem('pwCfg', JSON.stringify(next));
    return next;
  }

  function renderHeader(grouped){
    if(grouped){
      thead.innerHTML = `
        <tr class="border-b border-slate-800">
          <th class="text-left py-2">Max Score</th>
          <th class="text-left py-2">Nivel</th>
          <th class="text-left py-2">Procesos</th>
          <th class="text-left py-2">Usuarios</th>
          <th class="text-left py-2">Remoto</th>
          <th class="text-left py-2">DPort</th>
          <th class="text-left py-2">Servicio</th>
          <th class="text-left py-2">Beacon</th>
          <th class="text-left py-2">Ver</th>
        </tr>`;
    } else {
      thead.innerHTML = `
        <tr class="border-b border-slate-800">
          <th class="text-left py-2" title="Qué tan riesgosa es esta conexión">Score</th>
          <th class="text-left py-2" title="Bajo / Medio / Alto">Nivel</th>
          <th class="text-left py-2" title="Identificador de proceso">PID</th>
          <th class="text-left py-2" title="Nombre de la aplicación">Proceso</th>
          <th class="text-left py-2" title="Usuario dueño del proceso">Usuario</th>
          <th class="text-left py-2" title="Ruta del ejecutable">Ejecutable</th>
          <th class="text-left py-2" title="Firma de la app">Firma</th>
          <th class="text-left py-2" title="Tu IP/puerto local">Local</th>
          <th class="text-left py-2" title="A dónde se conecta (IP:puerto)">Destino</th>
          <th class="text-left py-2" title="Puerto de destino">Puerto</th>
          <th class="text-left py-2" title="Nombre del servicio del puerto (si existe)">Servicio</th>
          <th class="text-left py-2" title="Cantidad de diferentes destinos">Destinos</th>
          <th class="text-left py-2" title="Patrón repetitivo de conexión">Repetitivo</th>
          <th class="text-left py-2" title="Evidencia que sumó al score">Evidencia</th>
          <th class="text-left py-2">Plan</th>
          <th class="text-left py-2">Exportar</th>
          <th class="text-left py-2">Acciones</th>
        </tr>`;
    }
  }

  // Menú de opciones (dropdown)
  btnOptions.addEventListener('click', (e)=>{
    e.stopPropagation();
    menu.classList.toggle('hidden');
  });
  document.addEventListener('click', (e)=>{
    if(!menu.classList.contains('hidden')){
      const within = menu.contains(e.target) || btnOptions.contains(e.target);
      if(!within) menu.classList.add('hidden');
    }
  });

  // Asegura que solo existan los toggles dentro del menú (elimina duplicados visibles)
  (function ensureSingleOptions(){
    const ids = ['auto','groupBy','easyMode','hideApple','onlyNonApple','onlyEstablished'];
    for(const id of ids){
      const nodes = Array.from(document.querySelectorAll(`#${id}`));
      const keep = nodes.find(n => menu.contains(n)) || nodes[0];
      for(const n of nodes){
        if(n === keep) continue;
        const lbl = n.closest('label');
        if(lbl && !menu.contains(lbl)) lbl.remove(); else if(!menu.contains(n)) n.remove();
      }
    }
  })();
  // Inicializa config persistente y switches (Modo simple por defecto ON)
  (function initCfg(){
    const cfg0 = getCfg();
    const cfg = setCfg({ easyMode: cfg0.easyMode !== false, auto: cfg0.auto !== false, groupBy: !!cfg0.groupBy, hideApple: !!cfg0.hideApple, onlyNonApple: !!cfg0.onlyNonApple, onlyEstablished: !!cfg0.onlyEstablished });
    const ids = ['easyMode','auto','groupBy','hideApple','onlyNonApple','onlyEstablished'];
    for(const id of ids){ const el=document.getElementById(id); if(el && cfg[id]!==undefined) el.checked=!!cfg[id]; }
    ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('change', ()=>{ const o={}; o[id]=!!el.checked; setCfg(o); }); });
  })();

  // Helpers para Modo simple (clasificar IPs/roles y construir frases)
  function hostFrom(addr){ return (addr||'').split(':')[0] || ''; }
  function portFrom(addr){ const p=(addr||'').split(':').pop(); const n=Number(p); return Number.isFinite(n)? n : null; }
  function ipType(host){
    if(!host) return 'desconocido';
    if(host.startsWith('127.') || host === '::1') return 'tu Mac';
    if(host.startsWith('10.') || host.startsWith('192.168.') || /^172\.(1[6-9]|2\d|3[01])\./.test(host)) return 'tu red local';
    return 'Internet';
  }
  const TYPICAL_SERVER_PORTS = new Set([80,443,8000,8080,3000,5000,8888,27017,6379,5432,3306,22,5900]);
  // Evidencia por puertos (mantener en sync con server)
  const SENSITIVE_PORTS = new Set([22,23,25,445,3389,5900]);
  const MINING_PORTS = new Set([3333,4444]);
  const TOR_PORTS = new Set(Array.from({length:30}, (_,i)=>9001+i));
  function seemsServerLocal(r){
    const lh = hostFrom(r.laddr); const lp = portFrom(r.laddr);
    const rh = hostFrom(r.raddr);
    // Si el puerto local parece de servidor y el host local es loopback/privado
    return (lp && (lp <= 1024 || TYPICAL_SERVER_PORTS.has(lp))) && (ipType(lh) !== 'Internet');
  }
  // Chips/etiquetas de evidencia visibles por fila
  function chipsHtml(r){
    const chips = [];
    const add = (label, cls, title='') => chips.push(`<span class="inline-block px-2 py-0.5 rounded-full text-[11px] ${cls} ring-1" ${title?`title="${title}"`:''}>${label}</span>`);
    const exe = String(r.exe||'').toLowerCase();
    const host = hostFrom(r.raddr);
    const port = Number(r.dport);
    // /tmp hints
    if(exe.includes('/tmp') || exe.includes('/private/tmp') || exe.includes('/var/tmp') || exe.includes('/dev/shm')){
      add('/tmp', 'bg-orange-600/20 text-orange-300 ring-orange-800/50', 'Ejecutable en carpeta temporal');
    }
    // Puertos
    if(Number.isFinite(port) && SENSITIVE_PORTS.has(port)){
      add(`:${port}`, 'bg-red-600/20 text-red-300 ring-red-800/50', 'Puerto sensible');
    }
    if(Number.isFinite(port) && MINING_PORTS.has(port)){
      add('minería', 'bg-purple-600/20 text-purple-300 ring-purple-800/50', 'Puerto típico de minería (Stratum)');
    }
    if(Number.isFinite(port) && TOR_PORTS.has(port)){
      add('tor', 'bg-indigo-600/20 text-indigo-300 ring-indigo-800/50', 'Puerto típico de Tor');
    }
    // IP pública
    if(ipType(host)==='Internet'){
      add('IP pública', 'bg-sky-600/20 text-sky-300 ring-sky-800/50', 'Conexión hacia Internet');
    }
    // Binario reciente + salida
    if(r.exe_recent && ipType(host)==='Internet'){
      add('reciente', 'bg-teal-600/20 text-teal-300 ring-teal-800/50', 'Binario reciente con salida');
    }
    // Beaconing
    if(r.beacon){
      add('beacon', 'bg-yellow-600/20 text-yellow-300 ring-yellow-800/50', 'Patrón repetitivo de conexión');
    }
    // Firma/quarantine
    if(!r.signed){
      add('sin firma', 'bg-rose-600/20 text-rose-300 ring-rose-800/50', 'Aplicación sin firma');
    } else if(r.apple){
      add('Apple', 'bg-emerald-600/20 text-emerald-300 ring-emerald-800/50', 'Aplicación de Apple');
    }
    if(r.quarantine){
      add('quarantine', 'bg-rose-600/20 text-rose-300 ring-rose-800/50', 'Descargado recientemente');
    }
    // Muchos destinos
    if((r.unique_dsts||0) >= 10){
      add('10+ dsts', 'bg-fuchsia-600/20 text-fuchsia-300 ring-fuchsia-800/50', 'Muchos destinos distintos');
    } else if((r.unique_dsts||0) >= 5){
      add('5+ dsts', 'bg-fuchsia-600/20 text-fuchsia-300 ring-fuchsia-800/50', 'Varios destinos distintos');
    }
    // Marca si se aplicó una acción automática reciente
    try {
      const acted = JSON.parse(localStorage.getItem('pwActed')||'{}');
      const fp = `${r.pid}|${r.exe||''}|${r.raddr||''}`;
      const rec = acted[fp];
      const TTL = 2*60*1000;
      if(rec && (Date.now() - (rec.ts||0)) < TTL){
        if(rec.action === 'kill') add('killed', 'bg-red-700/30 text-red-300 ring-red-800/60', 'Auto KILL aplicado');
        if(rec.action === 'stop') add('stopped', 'bg-yellow-700/30 text-yellow-300 ring-yellow-800/60', 'Auto STOP aplicado');
      }
    } catch(_){ /* noop */ }
    return chips.join('');
  }

  function actionsHtml(r){
    const cfg = getCfg();
    const suspicious = (r.level === 'alto' || r.level === 'medio');
    if(!cfg.paranoid || !suspicious) return '';
    return `
      <div class="flex gap-1">
        <button class="act-stop px-2 py-1 text-xs bg-yellow-800 hover:bg-yellow-700 rounded" data-pid="${r.pid}" title="Enviar SIGSTOP (pausar)">STOP</button>
        <button class="act-kill px-2 py-1 text-xs bg-red-800 hover:bg-red-700 rounded" data-pid="${r.pid}" title="Enviar SIGKILL (forzar fin)">KILL</button>
      </div>`;
  }
  function reasonsShort(r){
    const map = {
      'Puerto sensible':'usa un puerto sensible',
      'Ejecutable en carpeta temporal':'se ejecuta desde carpeta temporal',
      'Conecta a Internet (IP pública)':'se conecta a Internet',
      'Patrón repetitivo de conexión':'tiene conexiones repetidas',
      'Muchos destinos distintos':'contacta muchos destinos',
      'Aplicación sin firma':'app sin firma',
      'Aplicación de Apple':'app de Apple',
      'Marcado como descargado recientemente':'app descargada recientemente',
      'Ejecutable en carpeta de usuario':'app en carpeta de usuario',
    };
    const seen = new Set();
    const out = [];
    for(const x of (r.reasons||[])){
      const t = map[x] || x.toLowerCase();
      if(!seen.has(t)) { seen.add(t); out.push(t); }
      if(out.length >= 2) break;
    }
    return out.join(', ');
  }
  function sentence(r){
    const level = r.level || 'bajo';
    const proc = r.proc || 'Una app';
    // Usuario: si parece numérico, ocultar para no técnicos
    let user = '';
    if(r.user && !/^\d+$/.test(String(r.user))){
      user = `de ${r.user}`;
      if(String(r.user).toLowerCase()==='root') user = 'del sistema';
    }
    const lh = hostFrom(r.laddr), lp = portFrom(r.laddr);
    const rh = hostFrom(r.raddr), rp = r.dport;
    const destType = ipType(rh);
    const service = r.service || (rp? `puerto ${rp}`: '');
    const rep = r.beacon ? ' y lo hace repetidamente' : '';
    const sign = r.apple ? 'de Apple' : (r.signed ? 'de un tercero' : 'sin firma');

    if(seemsServerLocal(r)){
      // Servidor local que atiende y además puede comunicarse
      const dest = rh ? (destType==='Internet' ? `y envía datos a Internet (${rh}:${rp||''})` : `y se comunica con ${destType} (${rh}:${rp||''})`) : '';
      return `Riesgo ${level}: ${proc} ${user} abre un servicio en tu Mac (usa el puerto ${lp}) ${dest ? dest : ''}. Es una app ${sign}${rep}.`;
    } else {
      // Cliente que se conecta hacia algo
      const dest = rh ? (destType==='Internet' ? `a Internet (${rh}:${rp||''})` : `dentro de ${destType} (${rh}:${rp||''})`) : 'a un destino desconocido';
      return `Riesgo ${level}: ${proc} ${user} se conecta ${dest}${service ? ` (${service})` : ''}. Es una app ${sign}${rep}.`;
    }
  }

  // Vista simples: normales y razones legibles
  function normalReasons(r){
    const arr = [];
    if(r.apple) arr.push('app de Apple');
    else if(r.signed) arr.push('app firmada');
    if(!r.beacon) arr.push('sin repeticiones anormales');
    if(r.service) arr.push(`usa ${r.service}`);
    return arr.slice(0,2).join(', ');
  }
  // Auto-actuar sobre procesos sospechosos en modo paranoico
  function _getActed(){ try{ return JSON.parse(localStorage.getItem('pwActed')||'{}'); }catch(_){ return {}; } }
  function _setActed(map){ try{ localStorage.setItem('pwActed', JSON.stringify(map)); }catch(_){ } }
  function _fp(r){ return `${r.pid}|${r.exe||''}|${r.raddr||''}`; }
  async function autoAct(rows){
    const cfg = getCfg();
    if(!cfg.paranoid) return;
    const action = (cfg.paranoidAction === 'stop') ? 'stop' : 'kill';
    const acted = _getActed();
    const TTL = 2*60*1000; // 2 min para evitar repetir spam
    // Consideramos sospechosos: nivel medio/alto
    const targets = rows.filter(r => r && (r.level==='alto' || r.level==='medio'));
    for(const r of targets){
      const fp = _fp(r);
      const rec = acted[fp];
      if(rec && (Date.now() - (rec.ts||0)) < TTL) continue; // ya actuamos recientemente
      try {
        const url = action==='stop' ? `/api/proc_stop?pid=${r.pid}` : `/api/proc_kill?pid=${r.pid}`;
        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();
        if(data && data.ok){
          acted[fp] = { ts: Date.now(), action };
          _setActed(acted);
          // Marca visual inmediata en meta
          try { meta.textContent = meta.textContent + ` • Auto ${action.toUpperCase()}: PID ${r.pid}`; } catch(_){ }
        }
      } catch(_){ /* ignore */ }
    }
  }
  function renderNormals(all){
    const normals = all.filter(r => r.level==='bajo').slice(0,20);
    const el = $('#normList');
    el.innerHTML = normals.map(r=>{
      const line = sentence(r);
      const why = normalReasons(r);
      return `
        <div class=\"flex items-start justify-between gap-3 p-3 rounded-md bg-slate-900 ring-1 ring-slate-800\">
          <div>
            <div class=\"font-medium\">${line}</div>
            <div class=\"text-slate-300 text-sm\">Motivos: ${why || 'actividad normal'}</div>
          </div>
          <div class=\"flex items-center gap-2\">${badge('bajo')} <button class=\"ver-normal px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">Ver</button></div>
        </div>`;
    }).join('');
    const btn = $('#toggleNormals');
    btn.onclick = ()=>{ el.classList.toggle('hidden'); btn.textContent = el.classList.contains('hidden')? 'Mostrar' : 'Ocultar'; };
    // Agregar acción Ver para normales
    $$('.ver-normal', el).forEach((b, i)=>{
      b.addEventListener('click', ()=>{
        const r = normals[i] || {};
        openModal('Detalle de conexión', `Proceso: ${r.proc} (PID ${r.pid})\nUsuario: ${r.user}\nEjecutable: ${r.exe}\nDestino: ${r.raddr}\nPuerto/Servicio: ${r.dport||''} ${r.service||''}\nNivel: ${r.level} • Score: ${(r.score||0).toFixed(2)}\nMotivos: ${(r.reasons||[]).join(', ') || (normalReasons(r)||'actividad normal')}`);
      });
    });
  }

  // Historial en localStorage (por día)
  function hash32(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h>>>0; }
  function updateHistory(rows){
    const date = new Date();
    const d = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    let hist = {};
    try{ hist = JSON.parse(localStorage.getItem('pwHistory')||'{}'); }catch(_){ hist={}; }
    if(!hist[d]) hist[d] = { seen:{}, byApp:{} };
    const H = hist[d];
    for(const r of rows){
      const id = `${r.pid}|${r.laddr}|${r.raddr}|${r.dport||''}|${r.status||''}`;
      const k = String(hash32(id));
      if(H.seen[k]) continue; // ya contado
      H.seen[k] = 1;
      const akey = `${r.proc||'?'}|${r.exe||''}`;
      const rec = H.byApp[akey] || {proc: r.proc||'?', exe: r.exe||'', count:0, last:0, dests:{}};
      rec.count += 1;
      rec.last = Date.now();
      const host = hostFrom(r.raddr);
      if(host) rec.dests[host] = (rec.dests[host]||0)+1;
      H.byApp[akey] = rec;
    }
    try{ localStorage.setItem('pwHistory', JSON.stringify(hist)); }catch(_){ /* ignore quota */ }
    // Render resumen
    const list = Object.values(H.byApp||{}).sort((a,b)=> b.count-a.count).slice(0,5);
    $('#histList').innerHTML = list.length? list.map(x=>{
      const dcount = Object.keys(x.dests||{}).length;
      return `<div>• ${x.proc} — ${x.count} conexiones • ${dcount} destinos</div>`;
    }).join('') : '<div class="text-slate-500">Sin datos acumulados</div>';
    $('#clearHistory').onclick = ()=>{ try{ delete hist[d]; localStorage.setItem('pwHistory', JSON.stringify(hist)); }catch(_){ } ; $('#histList').innerHTML='<div class="text-slate-500">Historial borrado</div>'; };
  }

  // Queue de revisiones (persiste sospechosas para revisar más tarde)
  function getReview(){ try{ return JSON.parse(localStorage.getItem('pwReview')||'{}'); }catch(_){ return {}; } }
  function saveReview(obj){ try{ localStorage.setItem('pwReview', JSON.stringify(obj||{})); }catch(_){ } }
  function reviewId(r){
    const exe = r.exe||''; const proc=r.proc||'?';
    const lport = portFrom(r.laddr); const host=hostFrom(r.raddr); const dport=r.dport||'';
    if(seemsServerLocal(r)){
      // Agrupar por ejecutable + puerto local (servidor)
      return String(hash32(`srv|${proc}|${exe}|${lport||''}`));
    }
    // Cliente: agrupar por ejecutable + destino + puerto destino
    return String(hash32(`cli|${proc}|${exe}|${host||''}|${dport}`));
  }
  function updateReview(rows){
    let q = getReview();
    if(!q.items) q.items = {};
    // Marcar todo inactivo antes de actualizar
    for(const id in q.items){ if(Object.prototype.hasOwnProperty.call(q.items,id)) q.items[id].active = false; }
    for(const r of (rows||[])){
      if(r.level === 'bajo') continue;
      const id = reviewId(r);
      const it = q.items[id] || { id, ts: Date.now(), dismissed: false, archived: false, active: true, data: r, count: 0, seen: {} };
      it.active = true;
      it.data = r; // snapshot más reciente
      it.ts = Date.now();
      // Contador por eventos únicos (evita duplicados por refresh)
      const fp = `${r.pid}|${r.laddr}|${r.raddr}|${r.dport||''}|${r.status||''}`;
      const h = String(hash32(fp));
      if(!it.seen[h]){
        it.seen[h] = 1;
        it.count = (it.count||0) + 1;
      }
      // Si estaba archivado y vuelve a estar activo, reaparece automáticamente
      if(it.archived && it.active){ it.archived = false; }
      q.items[id] = it;
    }
    // Límite de elementos (poda más antiguos si excede 200)
    const ids = Object.keys(q.items);
    if(ids.length > 200){
      ids.sort((a,b)=> (q.items[a].ts||0) - (q.items[b].ts||0));
      const toRemove = ids.slice(0, ids.length-200);
      for(const id of toRemove) delete q.items[id];
    }
    saveReview(q);
    return q;
  }

  const tpl = `
    <tr class="border-b border-slate-900 hover:bg-slate-900/40">
      <td class="py-2 pr-3 mono">{{score}}</td>
      <td class="py-2 pr-3">{{badge}}</td>
      <td class="py-2 pr-3 mono">{{pid}}</td>
      <td class="py-2 pr-3">{{proc}}</td>
      <td class="py-2 pr-3">{{user}}</td>
      <td class="py-2 pr-3 mono text-slate-300 truncate max-w-[22ch]" title="{{exe}}">{{exe}}</td>
      <td class="py-2 pr-3">{{sign}}</td>
      <td class="py-2 pr-3 mono text-slate-300">{{laddr}}</td>
      <td class="py-2 pr-3 mono">{{raddr}}</td>
      <td class="py-2 pr-3 mono">{{dport}}</td>
      <td class="py-2 pr-3">{{service}}</td>
      <td class="py-2 pr-3 mono">{{unique_dsts}}</td>
      <td class="py-2 pr-3">{{beacon}}</td>
      <td class="py-2 pr-3 text-slate-300"><div class="flex flex-wrap gap-1">{{chips}}</div></td>
      <td class="py-2"><button class="plan px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded">Ver</button></td>
      <td class="py-2">
        <select class="export-sel px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded">
          <option value="">Descargar…</option>
          <option value="json">JSON</option>
          <option value="md">MD</option>
        </select>
      </td>
      <td class="py-2">{{actions}}</td>
    </tr>`;

  function badge(level){
    const map = {
      alto: 'bg-red-600/20 text-red-300 ring-1 ring-red-800/50',
      medio: 'bg-yellow-600/20 text-yellow-300 ring-1 ring-yellow-800/50',
      bajo: 'bg-emerald-600/20 text-emerald-300 ring-1 ring-emerald-800/50'
    };
    return `<span class="px-2 py-0.5 rounded-lg text-xs ${map[level]||''}">${level}</span>`;
  }

  function groupLevel(score){
    if(score >= 7) return 'alto';
    if(score >= 4) return 'medio';
    return 'bajo';
  }

  function groupRows(rows){
    const map = new Map();
    for(const r of rows){
      const host = (r.raddr||'').split(':')[0] || '';
      const key = host + ':' + (r.dport||'');
      if(!map.has(key)){
        map.set(key, {
          key, host, port: r.dport||'', service: r.service||'',
          count: 0, pids: new Set(), users: new Set(),
          procs: new Map(),
          maxScore: 0, sumScore: 0, beacons: 0,
          rows: []
        });
      }
      const g = map.get(key);
      g.count++;
      if(r.pid!=null) g.pids.add(r.pid);
      if(r.user) g.users.add(r.user);
      const pn = r.proc||'?';
      g.procs.set(pn, (g.procs.get(pn)||0)+1);
      const sc = Number(r.score||0);
      g.maxScore = Math.max(g.maxScore, sc);
      g.sumScore += sc;
      if(r.beacon) g.beacons++;
      g.rows.push(r);
    }
    const arr = Array.from(map.values());
    arr.sort((a,b)=> b.maxScore - a.maxScore || b.count - a.count);
    return arr;
  }

  // Botón global de modo paranoico
  function updateParanoidBtn(){
    const cfg = getCfg();
    const on = !!cfg.paranoid;
    const b = $('#paranoidBtn');
    if(!b) return;
    b.textContent = `Modo paranoico: ${on? 'ON':'OFF'}`;
    b.classList.toggle('bg-red-800', !on);
    b.classList.toggle('bg-red-700', on);
    b.classList.toggle('ring-red-900', !on);
    b.classList.toggle('ring-red-700', on);
    const sel = $('#paranoidActionSel');
    if(sel){
      if(!cfg.paranoidAction){ setCfg({ paranoidAction: 'kill' }); }
      sel.classList.toggle('hidden', !on);
      sel.value = (getCfg().paranoidAction === 'stop') ? 'stop' : 'kill';
    }
  }
  $('#paranoidBtn').addEventListener('click', ()=>{
    const on = !getCfg().paranoid;
    setCfg({ paranoid: on });
    updateParanoidBtn();
    render(last);
  });
  $('#paranoidActionSel').addEventListener('change', ()=>{
    const sel = $('#paranoidActionSel');
    const val = (sel && sel.value) || 'kill';
    setCfg({ paranoidAction: (val === 'stop' ? 'stop' : 'kill') });
  });
  updateParanoidBtn();

  const tplGroup = `
    <tr class="border-b border-slate-900 hover:bg-slate-900/40">
      <td class="py-2 pr-3 mono">{{maxScore}}</td>
      <td class="py-2 pr-3">{{badge}}</td>
      <td class="py-2 pr-3">{{procSummary}}</td>
      <td class="py-2 pr-3">{{usersCount}}</td>
      <td class="py-2 pr-3 mono">{{remote}}</td>
      <td class="py-2 pr-3 mono">{{port}}</td>
      <td class="py-2 pr-3">{{service}}</td>
      <td class="py-2 pr-3">{{beacons}}</td>
      <td class="py-2">
        <button class="ver-grupo px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded">Ver</button>
      </td>
    </tr>`;

  function openModal(title, html){
    $('#modalTitle').textContent = title;
    $('#modalBody').innerHTML = html;
    const m = $('#modal');
    m.classList.remove('hidden');
    m.classList.add('flex');
    // Pausar auto-refresh mientras el modal está abierto para evitar parpadeos
    window._resumeAutoAfterModal = false;
    try {
      if($('#auto') && $('#auto').checked){
        window._resumeAutoAfterModal = true;
        clearInterval(timer);
      }
    } catch(_){/* noop */}
  }

  // Modal de confirmación amigable (promesa)
  function askConfirm(message, { okText='Aceptar', cancelText='Cancelar', tone='danger' } = {}){
    const okCls = (tone==='danger') ? 'bg-red-700 hover:bg-red-600 ring-red-900' : (tone==='warn' ? 'bg-yellow-700 hover:bg-yellow-600 ring-yellow-900' : 'bg-slate-700 hover:bg-slate-600 ring-slate-800');
    const html = `
      <div class="space-y-3">
        <div>${String(message||'¿Confirmar?')}</div>
        <div class="flex items-center gap-2 justify-end">
          <button id="cfCancel" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 ring-1 ring-slate-700">${cancelText}</button>
          <button id="cfOk" class="px-3 py-2 rounded text-white ring-1 ${okCls}">${okText}</button>
        </div>
      </div>`;
    openModal('Confirmar acción', html);
    return new Promise((resolve)=>{
      setTimeout(()=>{
        const ok = document.getElementById('cfOk');
        const no = document.getElementById('cfCancel');
        const off = ()=>{ try{ ok&&ok.removeEventListener('click', onOk); no&&no.removeEventListener('click', onNo); }catch(_){ } };
        const onOk = ()=>{ off(); closeModal(); resolve(true); };
        const onNo = ()=>{ off(); closeModal(); resolve(false); };
        if(ok) ok.addEventListener('click', onOk);
        if(no) no.addEventListener('click', onNo);
      }, 0);
    });
  }

  // Toasts ligeros para feedback de acciones (éxito/error)
  function toast(msg, type='info', ms=3000){
    try{
      let host = document.getElementById('toasts');
      if(!host){
        host = document.createElement('div');
        host.id = 'toasts';
        host.className = 'fixed right-4 bottom-4 z-50 flex flex-col gap-2';
        document.body.appendChild(host);
      }
      const el = document.createElement('div');
      const base = 'px-3 py-2 rounded ring-1 shadow text-sm cursor-pointer';
      const cls = type==='success' ? 'bg-emerald-800 text-emerald-50 ring-emerald-900' : (type==='error' ? 'bg-red-800 text-red-100 ring-red-900' : 'bg-slate-800 text-slate-100 ring-slate-700');
      el.className = base + ' ' + cls;
      el.textContent = String(msg||'');
      el.title = 'Click para cerrar';
      el.onclick = ()=>{ el.remove(); };
      host.appendChild(el);
      setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, ms);
    }catch(_){ /* noop */ }
  }

  // Alerta global: muestra "¡HACKEADO!" si hay conexiones sospechosas.
  // Permite resolver (ocultar) hasta que aparezca una nueva firma de hallazgo.
  function hackSig(rows){
    try{
      const items = (rows||[]).filter(r=>r && (r.level==='alto' || r.level==='medio'))
        .map(r=> `${(r.exe||r.proc||'?')}|${String(r.raddr||'').split(':')[0]}|${r.level}`)
        .sort();
      return items.join(';').slice(0,1000);
    } catch(_){ return ''; }
  }
  function updateHackAlert(rows){
    try {
      const alert = $('#hackAlert');
      if(!alert) return;
      const suspicious = (Array.isArray(rows) ? rows.filter(r => r && (r.level==='alto' || r.level==='medio')) : []);
      if(!suspicious.length){ alert.classList.add('hidden'); return; }
      const sig = hackSig(suspicious);
      const dismissed = localStorage.getItem('pwHackDismissSig') || '';
      if(!sig || sig === dismissed){ alert.classList.add('hidden'); return; }
      if(window._hackModalSigShown !== sig){
        window._hackModalSigShown = sig;
        const top = suspicious.slice(0,3).map(r => `• ${sentence(r)}`).join('\n');
        const extra = suspicious.length > 3 ? `\n…y ${suspicious.length-3} más.` : '';
        const html = `Se detectaron ${suspicious.length} conexiones para revisar.\n\n${top}${extra}\n\n<button id=\\"hackView\\" class=\\"px-3 py-2 bg-emerald-700 hover:bg-emerald-600 text-white rounded\\">Ver ahora<\\/button> <button id=\\"hackDismiss\\" class=\\"px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded\\">Resolver<\\/button>`;
        openModal('Atención de seguridad', html);
        setTimeout(()=>{
          const v = document.getElementById('hackView');
          const d = document.getElementById('hackDismiss');
          if(v){ v.onclick = ()=>{ try{ document.getElementById('modalClose').click(); }catch(_){ } setTimeout(()=>{ try{ document.getElementById('easyMode').checked = true; }catch(_){ } try{ document.getElementById('topList').scrollIntoView({ behavior: 'smooth' }); }catch(_){ } }, 50); }; }
          if(d){ d.onclick = ()=>{ try{ localStorage.setItem('pwHackDismissSig', sig); }catch(_){ } try{ document.getElementById('modalClose').click(); }catch(_){ } alert.classList.add('hidden'); }; }
        }, 0);
      }
      alert.dataset.sig = sig;
      alert.classList.add('hidden');
    } catch(_) { /* noop */ }
  }
  function closeModal(){
    const m = $('#modal');
    m.classList.add('hidden');
    m.classList.remove('flex');
    // Reanudar auto-refresh si estaba activo
    try {
      if(window._resumeAutoAfterModal){
        timer = setInterval(load, 2000);
        window._resumeAutoAfterModal = false;
      }
    } catch(_){/* noop */}
  }
  $('#modalClose').addEventListener('click', closeModal);
  $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });
  // Cerrar con ESC
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  function applyFilters(rows){
    const term = (q.value||'').toLowerCase().trim();
    const hideApple = $('#hideApple').checked;
    const onlyNonApple = $('#onlyNonApple').checked;
    const onlyEstablished = $('#onlyEstablished').checked;

    let out = rows;
    if(term){
      out = out.filter(r =>
        String(r.pid)===term || String(r.dport)===term ||
        (r.proc||'').toLowerCase().includes(term) ||
        (r.user||'').toLowerCase().includes(term) ||
        (r.exe||'').toLowerCase().includes(term) ||
        (r.laddr||'').toLowerCase().includes(term) ||
        (r.raddr||'').toLowerCase().includes(term) ||
        (r.level||'').toLowerCase().includes(term)
      );
    }
    if(hideApple) out = out.filter(r => !r.apple);
    if(onlyNonApple) out = out.filter(r => !r.apple);
    if(onlyEstablished) out = out.filter(r => (r.status||'') === 'ESTABLISHED');
    return out;
  }

  function render(rows){
    // Modo simple: vista resumida
    const easy = $('#easyMode') && $('#easyMode').checked;
    if(easy){
      const table = $('#table');
      const simple = $('#simple');
      table.classList.add('hidden');
      simple.classList.remove('hidden');

      const filtered = applyFilters(rows);
      const high = filtered.filter(r => r.level==='alto');
      const medium = filtered.filter(r => r.level==='medio');
      const low = filtered.filter(r => r.level==='bajo');

      const cards = [
        {title: 'Conexiones sospechosas', value: high.length, tone: 'bg-red-600/20 text-red-300 ring-1 ring-red-800/50'},
        {title: 'Conexiones a revisar', value: medium.length, tone: 'bg-yellow-600/20 text-yellow-300 ring-1 ring-yellow-800/50'},
        {title: 'Conexiones normales', value: low.length, tone: 'bg-emerald-600/20 text-emerald-300 ring-1 ring-emerald-800/50'},
      ];
      $('#summary').innerHTML = cards.map(c => `
        <div class="p-4 rounded-lg ${c.tone}">
          <div class="text-sm">${c.title}</div>
          <div class="text-3xl font-semibold">${c.value}</div>
        </div>`).join('');

      const review = updateReview(filtered);
      const showArchived = !!getCfg().showArchived;
      const top = Object.values(review.items||{})
        .filter(it => !it.dismissed)
        .filter(it => !it.archived)
        .sort((a,b)=> (b.ts||0)-(a.ts||0))
        .slice(0,20);
      $('#topList').innerHTML = top.map(it => {
        const r = it.data || {};
        const line = sentence(r);
        const why = reasonsShort(r);
        const chips = chipsHtml(r);
        const estado = it.active ? 'activa' : 'no activa';
        // No mostrar acciones aquí; se ofrecen dentro del modal de "Ver"
        const actions = '';
        return `
          <div class=\"flex items-start justify-between gap-3 p-3 rounded-md bg-slate-900 ring-1 ring-slate-800\">
            <div>
              <div class=\"font-medium\">${line} <span class=\"ml-2 text-xs text-slate-400\">x${it.count||1}</span></div>
              <div class=\"text-slate-300 text-sm\">Motivos: ${why || 'actividad de red detectada'} • Estado: ${estado}</div>
              <div class=\"mt-1 flex flex-wrap gap-1\">${chips}</div>
              ${actions}
            </div>
            <div class=\"flex items-center gap-2\"> 
              <span class=\"text-sm\">${badge(r.level)}</span> 
              <button data-id=\"${it.id}\" class=\"ver-simple px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">Ver</button>
              <select data-id=\"${it.id}\" class=\"export-sel-q px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">
                <option value=\"\">Descargar…</option>
                <option value=\"json\">JSON</option>
                <option value=\"md\">MD</option>
              </select>
              <button data-id=\"${it.id}\" class=\"archive px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">Cerrar</button>
              <button data-id=\"${it.id}\" class=\"dismiss px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">Descartar</button>
          </div>
         </div>`;
      }).join('');

      // Acciones del queue (ver, descartar, cerrar/archivar)
      $$('.ver-simple', $('#topList')).forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          const it = (getReview().items||{})[id];
          const r = (it && it.data) || {};
          const canKill = (r.level === 'medio' || r.level === 'alto');
          const body = `
            <div class="space-y-2">
              <div><b>Proceso:</b> ${r.proc} (PID ${r.pid})</div>
              <div><b>Usuario:</b> ${r.user}</div>
              <div><b>Ejecutable:</b> ${r.exe}</div>
              <div><b>Destino:</b> ${r.raddr}</div>
              <div><b>Puerto/Servicio:</b> ${r.dport||''} ${r.service||''}</div>
              <div><b>Nivel:</b> ${r.level} • <b>Score:</b> ${(r.score||0).toFixed(2)}</div>
              <div><b>Motivos:</b> ${(r.reasons||[]).join(', ')}</div>
              <div id="modalActions" class="mt-2 space-x-2">
                ${canKill ? `<button id="killInModal" data-pid="${r.pid}" class="px-3 py-2 bg-red-700 hover:bg-red-600 text-white rounded ring-1 ring-red-900">KILL (SIGKILL)</button>` : ''}
              </div>
            </div>`;
          openModal('Detalle de conexión', body);
          // Wire botón KILL dentro del modal si aplica
          setTimeout(()=>{
            const k = document.getElementById('killInModal');
            if(k){
              k.addEventListener('click', async ()=>{
                const pid = Number(k.getAttribute('data-pid'));
                if(!pid) return;
                if(!(await askConfirm(`¿Terminar proceso PID ${pid} (SIGKILL)?`, { okText: 'Sí, terminar', tone: 'danger' }))) return;
                try{
                  const res = await fetch(`/api/proc_kill?pid=${pid}`, { method: 'POST' });
                  const data = await res.json();
                  if(data && data.ok) toast(`Proceso ${pid} terminado.`, 'success'); else toast(`Error: ${data.error||'fallo'}`, 'error');
                  closeModal();
                  load();
                } catch(_){ toast('Error al terminar proceso', 'error'); }
              });
            }
            // Acciones extra: árbol y bootout
            const actions = document.getElementById('modalActions');
            const pid = Number(r.pid);
            if(actions && pid){
              fetch(`/api/proc_tree?pid=${r.pid}`).then(res=>res.json()).then(info=>{
                // Kill árbol solo si hay descendientes
                const count = Number((info && info.children_count) || 0);
                if(count > 0){
                  const bt1 = document.createElement('button');
                  bt1.id = 'killTreeInModal';
                  bt1.textContent = `Kill árbol (${count})`;
                  bt1.className = 'px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded ring-1 ring-slate-800';
                  actions.appendChild(bt1);
                  bt1.addEventListener('click', async ()=>{
                    if(!(await askConfirm(`¿Terminar árbol de procesos de PID ${pid} (descendientes ${count})?`, { okText: 'Sí, terminar', tone: 'danger' }))) return;
                    try{
                      const res = await fetch(`/api/proc_kill_tree?pid=${pid}`, { method: 'POST' });
                      const data = await res.json();
                      if(data && data.ok) toast(`Árbol terminado (${(data.killed||[]).length} procesos).`, 'success'); else toast(`Error: ${data.error||'fallo'}`, 'error');
                      closeModal();
                      load();
                    } catch(_){ toast('Error al terminar árbol', 'error'); }
                  });
                }
                // Kill grupo (PGID)
                if(info && info.pgid){
                  const btg = document.createElement('button');
                  btg.id = 'killGroupInModal';
                  btg.textContent = `Kill grupo (pgid ${info.pgid})`;
                  btg.className = 'px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded ring-1 ring-slate-800';
                  actions.appendChild(btg);
                  btg.addEventListener('click', async ()=>{
                    if(!(await askConfirm(`¿Terminar todo el grupo ${info.pgid}?`, { okText: 'Sí, terminar', tone: 'danger' }))) return;
                    try{
                      const res = await fetch(`/api/proc_kill_pgid?pid=${pid}`, { method: 'POST' });
                      const data = await res.json();
                      if(data && data.ok) toast(`Grupo ${data.pgid} terminado.`, 'success'); else toast(`Error: ${data.error||'fallo'}`, 'error');
                      closeModal();
                      load();
                    } catch(_){ toast('Error al terminar grupo', 'error'); }
                  });
                }
                // Bootout si hay label
                if(info && info.launchd && info.launchd.label){
                  const bt2 = document.createElement('button');
                  bt2.id = 'bootoutInModal';
                  bt2.textContent = `Bootout ${info.launchd.label}`;
                  bt2.className = 'px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded ring-1 ring-slate-800';
                  actions.appendChild(bt2);
                  bt2.addEventListener('click', async ()=>{
                    if(!(await askConfirm(`¿Intentar bootout de ${info.launchd.label}?`, { okText: 'Sí, ejecutar', tone: 'warn' }))) return;
                    try{
                      const res = await fetch(`/api/proc_bootout?pid=${pid}`, { method: 'POST' });
                      const data = await res.json();
                      if(data.ok){
                        const lines = (data.results||[]).map(r=>`${r.cmd} (rc=${r.rc})\n${(r.stdout||'').trim()}\n${(r.stderr||'').trim()}`).join('\n\n');
                        openModal('Resultados bootout', `<pre class=\"mono whitespace-pre-wrap\">${lines.replace(/[&<>]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</pre>`);
                      } else {
                        toast(`Error: ${data.error||'fallo'}`, 'error');
                      }
                      closeModal();
                      load();
                    } catch(_){ toast('Error al ejecutar bootout', 'error'); }
                  });
                }
              }).catch(()=>{});
            }
          }, 0);
        });
      });
      $$('.dismiss', $('#topList')).forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          const rq = getReview();
          if(rq.items && rq.items[id]){ rq.items[id].dismissed = true; saveReview(rq); }
          render(last);
        });
      });
      // Exportar desde la cola (modo simple)
      function dlQ(id, fmt){
        const it = (getReview().items||{})[id];
        const r = (it && it.data) || {};
        const safe = String(r.raddr||'dst').replace(/[:]/g,'-');
        const url = `/api/export_case?pid=${r.pid}&raddr=${encodeURIComponent(r.raddr||'')}&fmt=${fmt}`;
        fetch(url).then(async res => {
          const blob = await res.blob();
          let fname = `portwatch_case_pid${r.pid}_${safe}.${fmt==='md'?'md':'json'}`;
          const cd = res.headers.get('Content-Disposition') || '';
          const m = cd.match(/filename=([^;]+)/i);
          if(m){ fname = m[1].replace(/"/g,'').trim(); }
          const a = document.createElement('a');
          const obj = URL.createObjectURL(blob);
          a.href = obj; a.download = fname; document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(obj); a.remove(); }, 0);
        });
      }
      $$('.export-sel-q', $('#topList')).forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const fmt = sel.value;
          if(!fmt) return;
          dlQ(sel.getAttribute('data-id'), fmt);
          sel.value='';
        });
      });
      // (Sin acciones directas en la tarjeta; usar el modal)
      // Botón Cerrar (archivar sin perder contador)
      $$('.archive', $('#topList')).forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          const rq = getReview();
          if(rq.items && rq.items[id]){ rq.items[id].archived = true; saveReview(rq); }
          render(last);
        });
      });

      // Render archivados si está habilitado
      const archBtn = $('#toggleArchived');
      const archList = $('#archList');
      const setArchBtn = (show) => { archBtn.textContent = show ? 'Ocultar archivados' : 'Mostrar archivados'; };
      archBtn.onclick = () => {
        const cfg = setCfg({ showArchived: !getCfg().showArchived });
        archList.classList.toggle('hidden', !cfg.showArchived);
        setArchBtn(cfg.showArchived);
        render(last);
      };
      archList.classList.toggle('hidden', !showArchived);
      setArchBtn(showArchived);
      if(showArchived){
        const archived = Object.values(review.items||{})
          .filter(it => !it.dismissed && it.archived)
          .sort((a,b)=> (b.ts||0)-(a.ts||0))
          .slice(0,50);
        archList.innerHTML = archived.map(it => {
          const r = it.data||{}; const line = sentence(r); const why = reasonsShort(r); const chips = chipsHtml(r);
          return `
            <div class=\"flex items-start justify-between gap-3 p-3 rounded-md bg-slate-900 ring-1 ring-slate-800\">
              <div>
                <div class=\"font-medium\">${line} <span class=\"ml-2 text-xs text-slate-400\">x${it.count||1}</span></div>
                <div class=\"text-slate-300 text-sm\">Motivos: ${why || 'actividad de red detectada'} • Estado: ${it.active? 'activa':'no activa'}</div>
                <div class=\"mt-1 flex flex-wrap gap-1\">${chips}</div>
              </div>
              <div class=\"flex items-center gap-2\">
                <button data-id=\"${it.id}\" class=\"reopen px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">Reabrir</button>
                <button data-id=\"${it.id}\" class=\"dismiss px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 rounded\">Descartar</button>
              </div>
            </div>`;
        }).join('');
        $$('.reopen', archList).forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-id');
            const rq = getReview();
            if(rq.items && rq.items[id]){ rq.items[id].archived = false; saveReview(rq); }
            render(last);
          });
        });
        $$('.dismiss', archList).forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-id');
            const rq = getReview();
            if(rq.items && rq.items[id]){ rq.items[id].dismissed = true; saveReview(rq); }
            render(last);
          });
        });
      }

      renderNormals(filtered);
      updateHistory(filtered);

      return;
    }
    // Tabla detallada
    $('#table').classList.remove('hidden');
    $('#simple').classList.add('hidden');
    const grouped = $('#groupBy').checked;
    renderHeader(grouped);
    const filtered = applyFilters(rows);

    if(grouped){
      const groups = groupRows(filtered);
      rowsEl.innerHTML = groups.map(g => {
        const procs = Array.from(g.procs.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([n,c])=>`${n} x${c}`).join(', ');
        const remote = `${g.host}:${g.port}`;
        return tplGroup
          .replace('{{maxScore}}', g.maxScore.toFixed(2))
          .replace('{{badge}}', badge(groupLevel(g.maxScore)))
          .replace('{{procSummary}}', `${g.count} procesos • ${procs}`)
          .replace('{{usersCount}}', `${g.users.size} usuarios`)
          .replace('{{remote}}', remote)
          .replace('{{port}}', g.port)
          .replace('{{service}}', g.service||'')
          .replace('{{beacons}}', g.beacons>0? `sí (${g.beacons})` : 'no');
      }).join('');

      $$('.ver-grupo', rowsEl).forEach((btn, i) => {
        const g = groups[i];
        btn.addEventListener('click', ()=>{
          const lines = [
            `Servicio: ${g.service||''} • Destino: ${g.host}:${g.port}`,
            `Procesos: ${g.count} • PIDs únicos: ${g.pids.size} • Usuarios: ${g.users.size}`,
            `Max score: ${g.maxScore.toFixed(2)} • Beacon: ${g.beacons}`,
            '',
            'Detalle por proceso:'
          ];
          for(const r of g.rows.slice(0,80)){
            lines.push(`PID ${r.pid} • ${r.proc} • ${r.user} • ${r.exe} • ${r.status}`);
          }
          if(g.rows.length>80) lines.push(`… y ${g.rows.length-80} más`);
          openModal('Grupo de servicio', lines.join('\n'));
        });
      });
    } else {
      rowsEl.innerHTML = filtered.map(r =>
        tpl
          .replace('{{score}}', (r.score||0).toFixed(2))
          .replace('{{badge}}', badge(r.level))
          .replace('{{pid}}', r.pid)
          .replace('{{proc}}', r.proc)
          .replace('{{user}}', r.user)
          .replace('{{exe}}', r.exe)
          .replace('{{sign}}', (r.apple? 'Apple' : (r.signed? '3ro' : 'Sin firma')) + (r.quarantine? ' +Quarantine' : ''))
          .replace('{{laddr}}', r.laddr)
          .replace('{{raddr}}', r.raddr)
          .replace('{{dport}}', r.dport)
          .replace('{{service}}', r.service || '')
          .replace('{{unique_dsts}}', r.unique_dsts)
          .replace('{{beacon}}', r.beacon ? 'sí' : 'no')
          .replace('{{chips}}', chipsHtml(r))
          .replace('{{actions}}', actionsHtml(r))
      ).join('');

      // Botones Plan por fila
      $$('.plan', rowsEl).forEach((btn, i) => {
        const r = filtered[i];
        btn.addEventListener('click', async () => {
          const res = await fetch(`/api/action_plan?pid=${r.pid}&raddr=${encodeURIComponent(r.raddr)}`);
          const data = await res.json();
          const html = `<pre class=\"whitespace-pre-wrap\">${(data.plan||[]).join('\n\n').replace(/[&<>]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</pre>`;
          openModal('Plan de acción', html);
        });
      });
      // Exportar evidencia por fila
      function dl(url, suggested){
        return fetch(url).then(async res => {
          const blob = await res.blob();
          let fname = suggested || 'portwatch_export';
          const cd = res.headers.get('Content-Disposition') || '';
          const m = cd.match(/filename=([^;]+)/i);
          if(m){ fname = m[1].replace(/"/g,'').trim(); }
          const a = document.createElement('a');
          const obj = URL.createObjectURL(blob);
          a.href = obj;
          a.download = fname;
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{ URL.revokeObjectURL(obj); a.remove(); }, 0);
        });
      }
      $$('.export-sel', rowsEl).forEach((sel, i) => {
        const r = filtered[i];
        sel.addEventListener('change', () => {
          const fmt = sel.value;
          if(!fmt) return;
          const safe = String(r.raddr||'dst').replace(/[:]/g,'-');
          dl(`/api/export_case?pid=${r.pid}&raddr=${encodeURIComponent(r.raddr)}&fmt=${fmt}`, `portwatch_case_pid${r.pid}_${safe}.${fmt==='md'?'md':'json'}`)
            .finally(()=>{ sel.value=''; });
        });
      });
      // Acciones STOP/KILL (modo paranoico)
      $$('.act-stop', rowsEl).forEach((btn) => {
        btn.addEventListener('click', async () => {
          const pid = Number(btn.getAttribute('data-pid'));
          if(!pid) return;
          if(!(await askConfirm(`¿Detener proceso PID ${pid} (SIGSTOP)?`, { okText: 'Sí, detener', tone: 'warn' }))) return;
          try{
            const res = await fetch(`/api/proc_stop?pid=${pid}`, { method: 'POST' });
            const data = await res.json();
            if(data && data.ok) toast(`Proceso ${pid} detenido.`, 'success'); else toast(`Error: ${data.error||'fallo'}`, 'error');
            load();
          } catch(_){ toast('Error al detener proceso', 'error'); }
        });
      });
      $$('.act-kill', rowsEl).forEach((btn) => {
        btn.addEventListener('click', async () => {
          const pid = Number(btn.getAttribute('data-pid'));
          if(!pid) return;
          if(!(await askConfirm(`¿Terminar proceso PID ${pid} (SIGKILL)?`, { okText: 'Sí, terminar', tone: 'danger' }))) return;
          try{
            const res = await fetch(`/api/proc_kill?pid=${pid}`, { method: 'POST' });
            const data = await res.json();
            if(data && data.ok) toast(`Proceso ${pid} terminado.`, 'success'); else toast(`Error: ${data.error||'fallo'}`, 'error');
            load();
          } catch(_){ toast('Error al terminar proceso', 'error'); }
        });
      });
    }
    // Actualizar histórico también en vista técnica
    try { updateHistory(filtered); } catch(_){ }
  }

  async function load(){
    try {
      const res = await fetch('/api/connections');
      const data = await res.json();
      last = data.rows || [];
      // Auto-acción en modo paranoico (Kill/Stop)
      try { autoAct(last); } catch(_){ }
      // Actualiza alerta de "Hackeado"
      updateHackAlert(last);
      const filteredNow = applyFilters(last).length;
      meta.textContent = `Conexiones: ${last.length} • Mostrando: ${filteredNow} • Actualizado: ${new Date(data.ts*1000).toLocaleTimeString()}`;
      render(last);
    } catch(e){
      meta.textContent = 'Error cargando datos';
    }
  }

  $('#refresh').addEventListener('click', load);
  // Resolver alerta de hackeado: oculta hasta que el conjunto de sospechosas cambie
  const hackResolve = document.getElementById('hackResolve');
  if(hackResolve){
    hackResolve.addEventListener('click', ()=>{
      try{
        const sig = (document.getElementById('hackAlert')||{}).dataset.sig || '';
        if(sig){ localStorage.setItem('pwHackDismissSig', sig); }
        (document.getElementById('hackAlert')||{}).classList.add('hidden');
      } catch(_){/* noop */}
    });
  }
  $('#auto').addEventListener('change', (e)=>{
    clearInterval(timer);
    if(e.target.checked){ timer = setInterval(load, 2000); }
  });
  $('#hideApple').addEventListener('change', ()=> render(last));
  $('#onlyNonApple').addEventListener('change', ()=> render(last));
  $('#onlyEstablished').addEventListener('change', ()=> render(last));
  $('#groupBy').addEventListener('change', ()=> render(last));
  $('#easyMode').addEventListener('change', ()=> render(last));
  q.addEventListener('input', ()=> render(last));

  load();
  if($('#auto').checked){ timer = setInterval(load, 2000); }
  </script>
  <!-- Tailwind safelist placeholder for dynamically injected elements -->
  <div class="hidden">
    <span class="px-3 py-2 bg-red-700 hover:bg-red-600 text-white rounded ring-1 ring-red-900 inline-flex items-center gap-2 ring-offset-1 ring-offset-slate-900">.</span>
    <span class="px-3 py-2 bg-red-800 hover:bg-red-700 text-white rounded ring-1 ring-red-900">.</span>
  </div>
</body>
</html>
